# LoRA 权重（Weight）设置指南

## 什么是 LoRA 权重？

**LoRA 权重（Weight）** 控制 LoRA 模型对生成结果的影响强度。

- **权重 = 1.0**：使用 LoRA 的完整效果（训练时的默认值）
- **权重 > 1.0**：增强 LoRA 效果（可能过强，导致异常）
- **权重 < 1.0**：减弱 LoRA 效果（可能过弱，效果不明显）
- **权重 = 0.0**：完全禁用 LoRA

## 如何找到训练时使用的权重？

### 方法 1：查看 Kohya 训练配置

1. **查找训练配置文件**：
   - 通常在训练输出目录中
   - 文件名可能是 `training_config.json` 或 `config.json`

2. **查找权重相关字段**：
   - `network_weight`：网络权重（通常是 1.0）
   - `network_dim`：网络维度
   - `network_alpha`：网络 alpha 值（影响权重缩放）

3. **Kohya 默认值**：
   - 训练时默认权重通常是 **1.0**
   - 如果训练配置中没有特殊设置，使用 **1.0**

### 方法 2：查看训练日志

在训练日志中查找类似信息：
```
network_weight: 1.0
network_alpha: 128
```

### 方法 3：查看 Kohya WebUI 设置

如果在 Kohya WebUI 中训练：
- 查看训练时的 "Network Weight" 设置
- 默认值通常是 **1.0**

## 如何设置权重以保持训练时的效果？

### 1. **从 1.0 开始（推荐）**

训练时的默认权重通常是 **1.0**，所以应该从 **1.0** 开始：

```yaml
lora:
  models:
    - path: "D:\\yunjin_train\\SD1.5\\output\\yunjin_style.safetensors"
      weight: 1.0  # ⬅️ 从 1.0 开始
      trigger_words: ["nanjing yunjin style"]
```

### 2. **测试不同权重值**

如果 1.0 效果不理想，可以尝试调整：

```yaml
# 效果太弱时，尝试增加
weight: 1.2  # 或 1.5

# 效果过强时，尝试降低
weight: 0.8  # 或 0.6
```

### 3. **权重范围建议**

| 权重值 | 效果 | 使用场景 |
|--------|------|----------|
| 0.5 - 0.7 | 较弱 | 轻微风格，不想完全覆盖原模型 |
| 0.8 - 0.9 | 适中偏弱 | 平衡风格和原模型特征 |
| **1.0** | **标准** | **训练时的默认值，推荐使用** |
| 1.1 - 1.3 | 较强 | 需要更明显的风格效果 |
| 1.5+ | 很强 | 可能导致异常，不推荐 |

## 当前配置分析

你当前的配置：

```yaml
weight: 0.5  # ⬅️ 当前设置
```

**问题**：0.5 可能**太弱**，导致 LoRA 效果不明显。

**建议**：
1. **先尝试 1.0**（训练时的默认值）
2. 如果效果过强，再降低到 0.8 或 0.9
3. 如果效果太弱，可以增加到 1.2

## 如何找到最佳权重？

### 步骤 1：从 1.0 开始测试

```yaml
weight: 1.0
```

使用相同的提示词和参数生成图片，查看效果。

### 步骤 2：根据效果调整

**如果效果太弱**（LoRA 特征不明显）：
- 尝试 `1.2` 或 `1.5`
- 逐步增加，直到效果满意

**如果效果过强**（出现异常、过度风格化）：
- 尝试 `0.8` 或 `0.6`
- 逐步降低，直到效果自然

**如果效果正好**：
- 保持当前权重值

### 步骤 3：对比 Kohya 中的效果

1. 在 Kohya 中使用相同的：
   - 提示词（包括触发词）
   - 采样器
   - CFG Scale
   - 推理步数
   - **LoRA 权重**（通常是 1.0）

2. 在 API 中使用相同的参数

3. 对比生成结果，调整权重直到效果一致

## 完整配置示例

### 推荐配置（从训练时默认值开始）

```yaml
lora:
  models:
    - path: "D:\\yunjin_train\\SD1.5\\output\\yunjin_style.safetensors"
      weight: 1.0  # ⬅️ 从 1.0 开始（训练时的默认值）
      trigger_words: ["nanjing yunjin style"]
```

### 如果 1.0 效果不理想

```yaml
lora:
  models:
    - path: "D:\\yunjin_train\\SD1.5\\output\\yunjin_style.safetensors"
      weight: 0.8  # ⬅️ 如果 1.0 过强，尝试 0.8
      trigger_words: ["nanjing yunjin style"]
```

或

```yaml
lora:
  models:
    - path: "D:\\yunjin_train\\SD1.5\\output\\yunjin_style.safetensors"
      weight: 1.2  # ⬅️ 如果 1.0 太弱，尝试 1.2
      trigger_words: ["nanjing yunjin style"]
```

## 重要提示

### 1. 权重不是唯一因素

除了权重，还需要确保：
- ✅ **触发词正确**（最重要！）
- ✅ 采样器相同
- ✅ CFG Scale 相同
- ✅ 推理步数相同
- ✅ 提示词格式相同

### 2. 不同 LoRA 可能需要不同权重

如果使用多个 LoRA：
```yaml
lora:
  models:
    - path: "./lora1.safetensors"
      weight: 1.0  # LoRA 1 的权重
    - path: "./lora2.safetensors"
      weight: 0.8  # LoRA 2 的权重（可能需要不同）
```

### 3. 修改权重后需要重启服务

修改 `config.yaml` 中的权重后，**必须重启服务**才能生效。

## 快速检查清单

- [ ] ✅ 从 **1.0** 开始（训练时的默认值）
- [ ] ✅ 确保触发词正确配置
- [ ] ✅ 使用与 Kohya 相同的采样器
- [ ] ✅ 使用与 Kohya 相同的 CFG Scale
- [ ] ✅ 使用与 Kohya 相同的推理步数
- [ ] ✅ 对比生成结果，调整权重
- [ ] ✅ 修改后重启服务

## 常见问题

### Q: 为什么我的权重是 0.5？

A: 0.5 可能太弱了。建议从 **1.0** 开始，这是训练时的默认值。

### Q: 如何知道训练时使用的权重是多少？

A: 
1. 查看训练配置文件中的 `network_weight`
2. 如果没有特殊设置，默认是 **1.0**
3. 查看训练日志

### Q: 权重可以超过 1.0 吗？

A: 可以，但不推荐超过 1.5。通常 1.0 - 1.3 是安全范围。

### Q: 为什么权重 1.0 效果和 Kohya 不一样？

A: 检查其他参数：
- 触发词是否正确
- 采样器是否相同
- CFG Scale 是否相同
- 推理步数是否相同

### Q: 权重和触发词哪个更重要？

A: **触发词更重要**！如果触发词不正确，权重再高也没用。先确保触发词正确，再调整权重。

## 总结

1. **默认权重应该是 1.0**（训练时的默认值）
2. **当前配置 0.5 可能太弱**，建议改为 1.0
3. **从 1.0 开始测试**，根据效果调整
4. **权重不是唯一因素**，确保触发词和其他参数都正确
5. **修改后重启服务**才能生效

## 推荐操作步骤

1. **修改配置**：
   ```yaml
   weight: 1.0  # 从 0.5 改为 1.0
   ```

2. **重启服务**

3. **测试生成**，使用与 Kohya 相同的参数

4. **对比结果**，如果效果不理想，再调整权重

5. **记录最佳权重值**，方便以后使用
