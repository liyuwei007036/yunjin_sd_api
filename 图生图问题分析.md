# 图生图结果不一致问题分析

## 问题描述
经过图生图后生成的图片和原图完全不一致。

## 已修复的问题

### 1. strength 参数处理问题
**问题**：当 strength 为 0 时，前端使用 `|| null` 会导致值丢失。

**修复**：
- 前端：修复了 strength=0 时的处理逻辑
- 后端：改进了 strength 参数的处理，确保值在 0.0-1.0 范围内

### 2. 图片格式问题
**问题**：没有确保图片是 RGB 格式。

**修复**：添加了图片格式转换，确保所有图片都是 RGB 格式。

### 3. 日志不足
**问题**：缺少详细的调试信息。

**修复**：添加了详细的日志记录，包括：
- 原图尺寸和格式
- strength 参数值
- 生成参数摘要
- 生成结果尺寸

## 可能导致结果不一致的原因

### 1. strength 值过高
- **默认值**：0.75（较大变化）
- **建议**：
  - 轻微调整：0.1-0.3
  - 风格转换：0.4-0.6
  - 大幅改造：0.7-0.9
  - 接近重新生成：1.0

### 2. prompt 太强
- 如果 prompt 描述的内容与原图差异很大，即使 strength 较低，结果也可能不一致
- **建议**：使用更贴近原图的 prompt，或者降低 guidance_scale

### 3. 图片尺寸不匹配
- 如果原图尺寸与模型训练尺寸差异很大，pipeline 会自动调整，可能导致构图变化
- **建议**：使用接近模型训练尺寸的图片（通常是 512x512 或 768x768）

### 4. guidance_scale 过高
- 过高的 guidance_scale（>10）会强制模型严格遵循 prompt，可能导致结果偏离原图
- **建议**：图生图时使用较低的 guidance_scale（5.0-8.0）

### 5. 采样器和步数
- 不同的采样器可能产生不同的结果
- 步数太少可能导致结果不稳定

## 使用建议

### 保持原图一致性的最佳实践：

1. **使用较低的 strength**（0.2-0.4）
2. **使用较低的 guidance_scale**（5.0-7.0）
3. **使用与原图相关的 prompt**，避免描述完全不同的内容
4. **使用合适的采样器**（推荐 DPMSolverMultistepScheduler）
5. **使用足够的推理步数**（30-50 步）

### 示例配置：

**轻微调整/修复**：
```json
{
  "strength": 0.2,
  "guidance_scale": 5.0,
  "num_inference_steps": 30
}
```

**风格转换**：
```json
{
  "strength": 0.5,
  "guidance_scale": 7.0,
  "num_inference_steps": 40
}
```

**大幅改造**：
```json
{
  "strength": 0.75,
  "guidance_scale": 7.5,
  "num_inference_steps": 50
}
```

## 调试方法

1. 查看日志中的参数值，确认 strength、guidance_scale 等参数是否正确
2. 尝试降低 strength 值（从 0.75 降到 0.3-0.5）
3. 尝试降低 guidance_scale（从默认值降到 5.0-7.0）
4. 检查 prompt 是否过于偏离原图内容
5. 尝试使用不同的采样器

## 技术细节

### 代码修复位置：
1. `app/services/sd_service.py` - `image_to_image` 方法
2. `static/js/app.js` - `handleImg2ImgSubmit` 函数

### 关键改进：
- 图片格式确保为 RGB
- strength 参数范围验证（0.0-1.0）
- 详细的日志记录
- 前端 strength=0 的处理修复
